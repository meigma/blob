name: Provenance Example

on:
  push:
    branches:
      - main
    paths:
      - 'examples/provenance/**'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/provenance-example

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.push.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version-file: go.mod

      - name: Install FlatBuffers compiler
        run: |
          curl -L https://github.com/google/flatbuffers/releases/download/v25.2.10/Linux.flatc.binary.clang++-18.zip -o flatc.zip
          unzip flatc.zip
          chmod +x flatc
          sudo mv flatc /usr/local/bin/

      - name: Generate FlatBuffers
        run: go generate ./...

      - name: Build provenance CLI
        working-directory: examples/provenance
        run: |
          go mod tidy
          go build -o provenance .

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push and sign archive
        id: push
        working-directory: examples/provenance
        run: |
          REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Push and sign with sigstore (keyless), capture output
          OUTPUT=$(./provenance push --ref "$REF" --sign 2>&1)
          echo "$OUTPUT"

          # Extract digest from the push output
          DIGEST=$(echo "$OUTPUT" | grep "Digest:" | awk '{print $2}')
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

          # Also tag and sign as latest
          ./provenance push --ref "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" --sign

  verify:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version-file: go.mod

      - name: Install FlatBuffers compiler
        run: |
          curl -L https://github.com/google/flatbuffers/releases/download/v25.2.10/Linux.flatc.binary.clang++-18.zip -o flatc.zip
          unzip flatc.zip
          chmod +x flatc
          sudo mv flatc /usr/local/bin/

      - name: Generate FlatBuffers
        run: go generate ./...

      - name: Build provenance CLI
        working-directory: examples/provenance
        run: |
          go mod tidy
          go build -o provenance .

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and verify archive
        working-directory: examples/provenance
        run: |
          REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-and-push.outputs.digest }}"
          echo "Pulling with signature verification: $REF"
          ./provenance pull \
            --ref "$REF" \
            --repo "meigma/blob" \
            --skip-attest \
            --output ./verified-output

      - name: Verify extraction
        working-directory: examples/provenance
        run: |
          echo "Verifying extracted files..."
          ls -la ./verified-output/

          # Check expected files exist
          test -f ./verified-output/config.json
          test -f ./verified-output/README.md
          test -f ./verified-output/data/sample.txt

          echo "All files verified successfully!"
