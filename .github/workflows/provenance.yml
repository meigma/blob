name: Provenance Example

on:
  push:
    branches:
      - main
    paths:
      - 'examples/provenance/**'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/provenance-example

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.push.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Install FlatBuffers compiler
        run: |
          curl -L https://github.com/google/flatbuffers/releases/download/v25.2.10/Linux.flatc.binary.clang++-18.zip -o flatc.zip
          unzip flatc.zip
          chmod +x flatc
          sudo mv flatc /usr/local/bin/

      - name: Generate FlatBuffers
        run: go generate ./...

      - name: Build provenance CLI
        working-directory: examples/provenance
        run: |
          go mod tidy
          go build -o provenance .

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push and sign archive
        id: push
        working-directory: examples/provenance
        run: |
          REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Push and sign with sigstore (keyless), capture output
          OUTPUT=$(./provenance push --ref "$REF" --sign 2>&1)
          echo "$OUTPUT"

          # Extract digest from the push output
          DIGEST=$(echo "$OUTPUT" | grep "Digest:" | awk '{print $2}')
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Generate SLSA provenance attestation
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v2.3.0
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      - name: Push latest tag
        working-directory: examples/provenance
        run: |
          # Also tag and sign as latest
          ./provenance push --ref "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" --sign

  verify:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Install FlatBuffers compiler
        run: |
          curl -L https://github.com/google/flatbuffers/releases/download/v25.2.10/Linux.flatc.binary.clang++-18.zip -o flatc.zip
          unzip flatc.zip
          chmod +x flatc
          sudo mv flatc /usr/local/bin/

      - name: Generate FlatBuffers
        run: go generate ./...

      - name: Build provenance CLI
        working-directory: examples/provenance
        run: |
          go mod tidy
          go build -o provenance .

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and verify archive
        working-directory: examples/provenance
        run: |
          REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build-and-push.outputs.digest }}"
          echo "Pulling with full verification: $REF"
          # Full verification chain:
          # 1. Sigstore: Verifies WHO signed the archive (GitHub Actions OIDC identity)
          # 2. SLSA: Verifies HOW the archive was built (build provenance attestation)
          # 3. Gittuf: Verifies WHETHER source changes were authorized (RSL verification)
          #
          # Note: Gittuf verification is skipped for PR builds because:
          # - PR merge refs (refs/pull/XX/merge) don't have RSL entries
          # - Gittuf RSL only tracks actual branch pushes to protected refs
          GITTUF_FLAG=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Skipping gittuf verification for PR build (PR refs don't have RSL entries)"
            GITTUF_FLAG="--skip-gittuf"
          fi
          ./provenance pull \
            --ref "$REF" \
            --repo "meigma/blob" \
            --output ./verified-output \
            $GITTUF_FLAG

      - name: Verify extraction
        working-directory: examples/provenance
        run: |
          echo "Verifying extracted files..."
          ls -la ./verified-output/

          # Check expected files exist
          test -f ./verified-output/config.json
          test -f ./verified-output/README.md
          test -f ./verified-output/data/sample.txt

          echo "All files verified successfully!"
